<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akƒ±llƒ± Termostat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: #16213e; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #0f3460; margin-bottom: 30px; }
        h2 { color: #e94560; margin-bottom: 15px; font-size: 18px; }
        .temp-display { text-align: center; font-size: 48px; font-weight: bold; color: #e94560; margin: 20px 0; }
        .status { display: flex; justify-content: space-between; margin: 10px 0; padding: 10px; background: #0f3460; border-radius: 5px; }
        .status-label { color: #aaa; }
        .status-value { color: #fff; font-weight: bold; }
        .control-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 14px; }
        input[type="number"], input[type="time"], select { width: 100%; padding: 10px; background: #0f3460; border: 1px solid #e94560; border-radius: 5px; color: #fff; font-size: 16px; }
        button { width: 100%; padding: 12px; background: #e94560; color: #fff; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #c23b52; }
        .relay-on { color: #4ecca3; }
        .relay-off { color: #aaa; }
        .schedule-item { background: #0f3460; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .schedule-item button { width: auto; padding: 5px 15px; margin: 0; }
        .hour-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 15px; }
        .hour-item { background: #0f3460; padding: 8px; border-radius: 5px; text-align: center; }
        .hour-item.current-hour { background: #e94560; border: 2px solid #4ecca3; }
        .hour-item label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .hour-item.current-hour label { color: #fff; font-weight: bold; }
        .hour-item input { width: 100%; padding: 5px; background: #1a1a2e; border: 1px solid #e94560; border-radius: 3px; color: #fff; text-align: center; font-size: 14px; }
        .day-selector { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .day-btn { padding: 10px 15px; background: #0f3460; border: none; color: #aaa; cursor: pointer; border-radius: 5px; font-size: 14px; }
        .day-btn.active { background: #e94560; color: #fff; }
        .schedule-actions { display: flex; gap: 10px; margin-top: 15px; }
        .current-time { text-align: center; font-size: 32px; font-weight: bold; color: #4ecca3; margin-bottom: 15px; padding: 15px; background: #0f3460; border-radius: 8px; }
        .current-time .date { font-size: 14px; color: #aaa; margin-top: 5px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: #16213e; margin: 10% auto; padding: 30px; border-radius: 10px; max-width: 400px; }
        .modal-content h3 { color: #e94560; margin-bottom: 20px; }
        .day-checkbox { display: flex; align-items: center; padding: 10px; margin: 5px 0; background: #0f3460; border-radius: 5px; cursor: pointer; }
        .day-checkbox:hover { background: #1a2a4e; }
        .day-checkbox input { margin-right: 10px; width: 20px; height: 20px; cursor: pointer; }
        .day-checkbox label { cursor: pointer; flex: 1; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .day-tabs { display: flex; overflow-x: auto; margin-bottom: 10px; }
        .day-tab { padding: 10px 15px; background: #0f3460; border: none; color: #aaa; cursor: pointer; white-space: nowrap; }
        .day-tab.active { background: #e94560; color: #fff; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .connected { background: #4ecca3; color: #000; }
        .disconnected { background: #e94560; color: #fff; }
        .device-status { position: fixed; top: 45px; right: 10px; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .device-online { background: #4ecca3; color: #000; }
        .device-offline { background: #666; color: #fff; }
        .toast { position: fixed; top: 70px; right: 10px; padding: 15px 20px; border-radius: 5px; font-size: 14px; background: #4ecca3; color: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.3); z-index: 2000; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #0f3460; border-radius: 5px; margin-top: 15px; }
        .toggle-label { display: flex; align-items: center; gap: 10px; }
        .toggle-label span { font-size: 16px; }
        .toggle-label small { color: #aaa; font-size: 12px; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #666; transition: .3s; border-radius: 26px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #e94560; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }
        .keylock-warning { background: #e94560; color: #fff; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px; display: none; }
        .keylock-warning.active { display: block; }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="mqttStatus">Baƒülanƒ±yor...</div>
    <div class="device-status device-offline" id="deviceStatus">üîå Cihaz: Bekleniyor...</div>
    
    <div class="container">
        <h1>üå°Ô∏è Akƒ±llƒ± Termostat</h1>
        
        <div class="card">
            <h2>Anlƒ±k Durum</h2>
            <div class="temp-display" id="currentTemp">--.-¬∞C</div>
            <div class="status">
                <span class="status-label">Nem:</span>
                <span class="status-value" id="humidity">--%</span>
            </div>
            <div class="status">
                <span class="status-label">Hedef:</span>
                <span class="status-value" id="targetTemp">--¬∞C</span>
            </div>
            <div class="status">
                <span class="status-label">Program:</span>
                <span class="status-value" id="scheduleStatus" style="font-size: 12px;">Bekleniyor...</span>
            </div>
            <div class="status">
                <span class="status-label">R√∂le:</span>
                <span class="status-value" id="relayStatus">--</span>
            </div>
        </div>
        
        <div class="card">
            <h2>Kontrol</h2>
            <div class="control-group" id="targetGroup">
                <label>Hedef Sƒ±caklƒ±k (¬∞C) <span id="targetModeHint" style="font-size: 11px; color: #e94560;">(Sadece Manuel Modda)</span></label>
                <input type="number" id="targetInput" min="15" max="30" step="0.5" value="22" disabled>
                <button id="targetButton" onclick="setTarget()" disabled style="opacity: 0.5;">Ayarla</button>
            </div>
            <div class="control-group">
                <label>Mod</label>
                <select id="modeSelect" onchange="setMode()">
                    <option value="auto">Otomatik</option>
                    <option value="manual">Manuel</option>
                </select>
            </div>
            <div class="toggle-container">
                <div class="toggle-label">
                    <span>üîí Tu≈ü Kilidi</span>
                    <small>(√áocuk Kilidi)</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="keyLockToggle" onchange="setKeyLock()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="keylock-warning" id="keyLockWarning">
                ‚ö†Ô∏è Tu≈ü kilidi aktif - Cihaz √ºzerinden kontrol devre dƒ±≈üƒ±!
            </div>
            <button onclick="showSettingsModal()" style="background: #0f3460; margin-top: 15px;">
                ‚öôÔ∏è Geli≈ümi≈ü Ayarlar
            </button>
        </div>
        
        <div class="card" id="scheduleCard">
            <h2>Haftalƒ±k Program</h2>
            
            <div class="current-time" id="currentTime">
                <div id="timeDisplay">--:--:--</div>
                <div class="date" id="dateDisplay">-- --, ----</div>
            </div>
            
            <div class="day-selector">
                <button class="day-btn active" onclick="selectDay('monday')">Pazartesi</button>
                <button class="day-btn" onclick="selectDay('tuesday')">Salƒ±</button>
                <button class="day-btn" onclick="selectDay('wednesday')">√áar≈üamba</button>
                <button class="day-btn" onclick="selectDay('thursday')">Per≈üembe</button>
                <button class="day-btn" onclick="selectDay('friday')">Cuma</button>
                <button class="day-btn" onclick="selectDay('saturday')">Cumartesi</button>
                <button class="day-btn" onclick="selectDay('sunday')">Pazar</button>
            </div>
            
            <div class="hour-grid" id="hourGrid"></div>
            
            <div class="schedule-actions">
                <button onclick="showCopyModal()" style="flex: 1; background: #0f3460;">G√ºn√º Kopyala</button>
                <button onclick="resetDay()" style="flex: 1; background: #666;">Sƒ±fƒ±rla</button>
            </div>
        </div>
    </div>

    <!-- Kopyalama Modal -->
    <div id="copyModal" class="modal">
        <div class="modal-content">
            <h3>Hangi g√ºnlere kopyalanacak?</h3>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-monday" value="monday">
                <label for="copy-monday">Pazartesi</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-tuesday" value="tuesday">
                <label for="copy-tuesday">Salƒ±</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-wednesday" value="wednesday">
                <label for="copy-wednesday">√áar≈üamba</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-thursday" value="thursday">
                <label for="copy-thursday">Per≈üembe</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-friday" value="friday">
                <label for="copy-friday">Cuma</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-saturday" value="saturday">
                <label for="copy-saturday">Cumartesi</label>
            </div>
            <div class="day-checkbox">
                <input type="checkbox" id="copy-sunday" value="sunday">
                <label for="copy-sunday">Pazar</label>
            </div>
            <div class="modal-buttons">
                <button onclick="applyCopy()" style="flex: 1;">Kopyala</button>
                <button onclick="closeCopyModal()" style="flex: 1; background: #666;">Iptal</button>
            </div>
        </div>
    </div>

    <!-- Geli≈ümi≈ü Ayarlar Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3>‚öôÔ∏è Geli≈ümi≈ü Ayarlar</h3>
            
            <div class="control-group">
                <label>Aralƒ±k (¬∞C)</label>
                <input type="number" id="hysteresisInput" min="0.1" max="3" step="0.1" value="0.5">
                <button onclick="setHysteresis()">Ayarla</button>
                <small style="display: block; color: #aaa; font-size: 11px; margin-top: 3px;">
                    Isƒ±tmanƒ±n a√ßƒ±lƒ±p kapanma aralƒ±ƒüƒ±
                </small>
            </div>
            
            <div class="control-group" style="margin-top: 15px;">
                <label>üîß Sens√∂r Kalibrasyonu (¬∞C)</label>
                <input type="number" id="calibrationInput" min="-5" max="5" step="0.1" value="0.0">
                <button onclick="setCalibration()">Ayarla</button>
                <small style="display: block; color: #aaa; font-size: 11px; margin-top: 3px;">
                    Sens√∂r sapmasƒ± varsa d√ºzeltme (√∂rn: +2.5)
                </small>
            </div>
            
            <div class="control-group" style="margin-top: 15px;">
                <label>üì∫ LCD Kontrast (40-80)</label>
                <input type="number" id="contrastInput" min="40" max="80" step="1" value="70">
                <button onclick="setContrast()">Ayarla</button>
                <small style="display: block; color: #aaa; font-size: 11px; margin-top: 3px;">
                    LCD √ßok koyu/a√ßƒ±k g√∂r√ºn√ºyorsa ayarlayƒ±n
                </small>
            </div>
            
            <button onclick="closeSettingsModal()" style="background: #666; margin-top: 20px;">
                Kapat
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let client;
        let currentDay = 'monday';
        let schedule = {};  // Bo≈ü ba≈ülat, loadSchedule veya initSchedule dolduracak
        let scheduleLoaded = false;  // MQTT'den veri geldi mi?
        
        // MQTT Otomatik Reconnect
        let reconnectAttempts = 0;
        let reconnectDelay = 5000;  // 5 saniye ba≈ülangƒ±√ß
        let reconnectTimer = null;
        let deviceOnline = false;
        let lastMessageTime = 0;
        let deviceCheckInterval = null;
        
        const dayNames = {
            'monday': 'Pazartesi',
            'tuesday': 'Salƒ±',
            'wednesday': '√áar≈üamba',
            'thursday': 'Per≈üembe',
            'friday': 'Cuma',
            'saturday': 'Cumartesi',
            'sunday': 'Pazar'
        };
        
        // Anlƒ±k saati g√ºncelle
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            const days = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            
            document.getElementById('timeDisplay').textContent = `${hours}:${minutes}:${seconds}`;
            document.getElementById('dateDisplay').textContent = `${dayName}, ${day} ${month} ${year}`;
            
            // Program durumunu g√ºncelle
            updateScheduleStatus(now);
        }
        
        function updateScheduleStatus(now) {
            const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = dayMap[now.getDay()];
            const currentHour = now.getHours();
            
            if (schedule[today] && schedule[today][currentHour]) {
                const programTemp = schedule[today][currentHour];
                document.getElementById('scheduleStatus').innerHTML = 
                    `<span style="color: #4ecca3;">‚úì Aktif: ${currentHour}:00 ‚Üí ${programTemp}¬∞C</span>`;
            } else {
                const nextHour = (currentHour + 1) % 24;
                if (schedule[today] && schedule[today][nextHour]) {
                    document.getElementById('scheduleStatus').innerHTML = 
                        `Sonraki: ${nextHour}:00 ‚Üí ${schedule[today][nextHour]}¬∞C`;
                } else {
                    document.getElementById('scheduleStatus').textContent = 'Program yok';
                }
            }
        }
        
        // Her saniye saati g√ºncelle
        setInterval(updateClock, 1000);
        updateClock();
        
        // Her g√ºn i√ßin varsayƒ±lan 22 derece
        function initSchedule() {
            schedule = {
                monday: {}, tuesday: {}, wednesday: {}, thursday: {},
                friday: {}, saturday: {}, sunday: {}
            };
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach(day => {
                for (let h = 0; h < 24; h++) {
                    schedule[day][h] = 22;
                }
            });
        }

        // MQTT Baƒülantƒ±sƒ± - BURAYA KENDƒ∞ BROKER Bƒ∞LGƒ∞LERƒ∞Nƒ∞ Gƒ∞R
        const MQTT_BROKER = 'wss://28e8bc8650f945549e20987d9ad50e06.s1.eu.hivemq.cloud:8884/mqtt';
        const MQTT_USER = 'kerim';
        const MQTT_PASSWORD = 'Yalova77.';
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 1500);
        }

        function connectMQTT() {
            console.log('MQTT baƒülanƒ±yor:', MQTT_BROKER);
            client = mqtt.connect(MQTT_BROKER, {
                username: MQTT_USER,
                password: MQTT_PASSWORD,
                clientId: 'WebApp_' + Math.random().toString(16).substr(2, 8),
                reconnectPeriod: 0  // Otomatik reconnect'i kapat (kendimiz y√∂neteceƒüiz)
            });

            client.on('connect', () => {
                console.log('‚úÖ MQTT baƒülandƒ±!');
                document.getElementById('mqttStatus').textContent = 'Baƒülƒ±';
                document.getElementById('mqttStatus').className = 'connection-status connected';
                
                // Ba≈üarƒ±lƒ± baƒülantƒ±, saya√ßlarƒ± sƒ±fƒ±rla
                reconnectAttempts = 0;
                reconnectDelay = 5000;
                
                client.subscribe('thermostat/status/#');
                client.subscribe('thermostat/control/#');
                client.subscribe('thermostat/schedule/update');
                client.subscribe('thermostat/control/keylock');
                client.subscribe('thermostat/control/calibration');
                client.subscribe('thermostat/control/contrast');
                
                // Baƒülanƒ±nca NodeMCU'dan program iste
                setTimeout(() => {
                    console.log('NodeMCU\'dan program isteniyor...');
                }, 1000);
            });

            client.on('message', (topic, message) => {
                const msg = message.toString();
                console.log('Mesaj:', topic, msg);
                
                // NodeMCU'dan mesaj geldi, cihaz online
                if (topic.startsWith('thermostat/status/')) {
                    if (!deviceOnline) {
                        deviceOnline = true;
                        document.getElementById('deviceStatus').textContent = '‚úÖ Cihaz: √áevrimi√ßi';
                        document.getElementById('deviceStatus').className = 'device-status device-online';
                        console.log('‚úÖ NodeMCU √ßevrimi√ßi!');
                    }
                    lastMessageTime = Date.now();
                }
                
                if (topic === 'thermostat/status/temperature') {
                    const tempDisplay = document.getElementById('currentTemp');
                    if (msg === 'ERROR') {
                        tempDisplay.textContent = '‚ö†Ô∏è SENS√ñR HATASI!';
                        tempDisplay.style.color = '#ff4444';
                        tempDisplay.style.fontSize = '24px';
                        showToast('‚ö†Ô∏è SENS√ñR ARIZASI - KOMBƒ∞ KAPATILDI!');
                    } else {
                        tempDisplay.textContent = parseFloat(msg).toFixed(1) + '¬∞C';
                        tempDisplay.style.color = '#e94560';
                        tempDisplay.style.fontSize = '48px';
                    }
                }
                else if (topic === 'thermostat/status/humidity') {
                    document.getElementById('humidity').textContent = parseFloat(msg).toFixed(1) + '%';
                }
                else if (topic === 'thermostat/status/relay') {
                    const status = document.getElementById('relayStatus');
                    status.textContent = msg === 'ON' ? 'A√áIK' : 'KAPALI';
                    status.className = msg === 'ON' ? 'status-value relay-on' : 'status-value relay-off';
                }
                else if (topic === 'thermostat/control/target') {
                    document.getElementById('targetTemp').textContent = parseFloat(msg).toFixed(1) + '¬∞C';
                    document.getElementById('targetInput').value = parseFloat(msg);
                }
                else if (topic === 'thermostat/control/hysteresis') {
                    document.getElementById('hysteresisInput').value = parseFloat(msg);
                }
                else if (topic === 'thermostat/control/mode') {
                    document.getElementById('modeSelect').value = msg;
                    localStorage.setItem('thermostat_mode', msg);  // Modu kaydet
                    updateTargetInputState(msg);
                }
                else if (topic === 'thermostat/control/keylock') {
                    const isLocked = (msg === 'ON');
                    document.getElementById('keyLockToggle').checked = isLocked;
                    document.getElementById('keyLockWarning').classList.toggle('active', isLocked);
                    localStorage.setItem('thermostat_keylock', msg);
                    console.log('Tu≈ü kilidi:', isLocked ? 'AKTƒ∞F' : 'KAPALI');
                }
                else if (topic === 'thermostat/control/calibration') {
                    document.getElementById('calibrationInput').value = parseFloat(msg);
                    localStorage.setItem('thermostat_calibration', msg);
                    console.log('Kalibrasyon:', msg + '¬∞C');
                }
                else if (topic === 'thermostat/control/contrast') {
                    document.getElementById('contrastInput').value = parseInt(msg);
                    localStorage.setItem('thermostat_contrast', msg);
                    console.log('LCD Kontrast:', msg);
                }
                else if (topic === 'thermostat/schedule/update') {
                    try {
                        const receivedSchedule = JSON.parse(msg);
                        schedule = receivedSchedule;
                        scheduleLoaded = true;
                        localStorage.setItem('thermostat_schedule', msg);
                        displayHours();
                        console.log('Program NodeMCU\'dan alƒ±ndƒ±:', schedule);
                    } catch (e) {
                        console.error('Program parse hatasƒ±:', e);
                        // Hata varsa localStorage'dan y√ºkle
                        if (!scheduleLoaded) {
                            loadSchedule();
                            displayHours();
                        }
                    }
                }
            });

            client.on('error', (err) => {
                console.error('‚ùå MQTT Hatasƒ±:', err);
                document.getElementById('mqttStatus').textContent = 'Baƒülantƒ± Hatasƒ±';
                document.getElementById('mqttStatus').className = 'connection-status disconnected';
            });

            client.on('close', () => {
                console.log('üîå MQTT baƒülantƒ± koptu');
                document.getElementById('mqttStatus').textContent = 'Baƒülantƒ± Koptu';
                document.getElementById('mqttStatus').className = 'connection-status disconnected';
                attemptReconnect();
            });

            client.on('offline', () => {
                console.log('üì¥ MQTT offline');
                document.getElementById('mqttStatus').textContent = '√áevrimi√ßi Deƒüil';
                document.getElementById('mqttStatus').className = 'connection-status disconnected';
                attemptReconnect();
            });
        }

        function attemptReconnect() {
            // Zaten bir timer varsa iptal et
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
            }
            
            reconnectAttempts++;
            
            // Exponential backoff: 5, 10, 20, 40, 60 saniye
            reconnectDelay = Math.min(reconnectDelay * 2, 60000);
            
            console.log(`üîÑ ${reconnectDelay / 1000} saniye sonra yeniden baƒülanƒ±lacak (Deneme: ${reconnectAttempts})`);
            
            // Kullanƒ±cƒ±ya g√∂ster
            document.getElementById('mqttStatus').textContent = 
                `Yeniden baƒülanƒ±yor (${reconnectDelay / 1000}s)`;
            
            reconnectTimer = setTimeout(() => {
                console.log('üîÑ Yeniden baƒülanma denemesi...');
                
                // Eski baƒülantƒ±yƒ± temizle
                if (client) {
                    client.end(true);  // Force close
                }
                
                // Yeni baƒülantƒ±
                connectMQTT();
            }, reconnectDelay);
        }

        function setTarget() {
            const value = parseFloat(document.getElementById('targetInput').value);
            if (value < 15 || value > 30) {
                showToast('Hedef sƒ±caklƒ±k 15-30¬∞C arasƒ± olmalƒ±!');
                return;
            }
            client.publish('thermostat/control/target', value.toString());
            document.getElementById('targetTemp').textContent = value + '¬∞C';
        }

        function setHysteresis() {
            const value = document.getElementById('hysteresisInput').value;
            client.publish('thermostat/control/hysteresis', value);
        }

        function setCalibration() {
            const value = parseFloat(document.getElementById('calibrationInput').value);
            if (value < -5 || value > 5) {
                showToast('Kalibrasyon -5 ile +5 arasƒ± olmalƒ±!');
                return;
            }
            client.publish('thermostat/control/calibration', value.toString(), {retain: true});
            showToast(`Kalibrasyon ${value > 0 ? '+' : ''}${value}¬∞C olarak ayarlandƒ±`);
        }

        function setContrast() {
            const value = parseInt(document.getElementById('contrastInput').value);
            if (value < 40 || value > 80) {
                showToast('Kontrast 40 ile 80 arasƒ± olmalƒ±!');
                return;
            }
            client.publish('thermostat/control/contrast', value.toString(), {retain: true});
            showToast(`LCD kontrast ${value} olarak ayarlandƒ±`);
        }

        function setMode() {
            const value = document.getElementById('modeSelect').value;
            client.publish('thermostat/control/mode', value);
            updateTargetInputState(value);
            
            // Otomatik moda ge√ßince aktif program deƒüerini hedef olarak g√∂nder
            if (value === 'auto') {
                const now = new Date();
                const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const today = dayMap[now.getDay()];
                const currentHour = now.getHours();
                
                if (schedule[today] && schedule[today][currentHour] !== undefined) {
                    const programTarget = schedule[today][currentHour];
                    // 2.5 saniye gecikme ile g√∂nder (NodeMCU'nun ignore s√ºresi bittikten sonra)
                    setTimeout(() => {
                        client.publish('thermostat/control/target', programTarget.toString(), {retain: true});
                        document.getElementById('targetTemp').textContent = programTarget.toFixed(1) + '¬∞C';
                        document.getElementById('targetInput').value = programTarget;
                        console.log('Oto mod: Program deƒüeri g√∂nderildi:', programTarget);
                    }, 2500);
                }
            }
        }
        
        function setKeyLock() {
            const isLocked = document.getElementById('keyLockToggle').checked;
            client.publish('thermostat/control/keylock', isLocked ? 'ON' : 'OFF', {retain: true});
            document.getElementById('keyLockWarning').classList.toggle('active', isLocked);
            showToast(isLocked ? 'üîí Tu≈ü kilidi aktif' : 'üîì Tu≈ü kilidi kapatƒ±ldƒ±');
        }
        
        function updateTargetInputState(mode) {
            const input = document.getElementById('targetInput');
            const button = document.getElementById('targetButton');
            const hint = document.getElementById('targetModeHint');
            const scheduleCard = document.getElementById('scheduleCard');
            
            if (mode === 'manual') {
                input.disabled = false;
                button.disabled = false;
                button.style.opacity = '1';
                hint.style.display = 'none';
                scheduleCard.style.display = 'none';  // Manuel modda gizle
            } else {
                input.disabled = true;
                button.disabled = true;
                button.style.opacity = '0.5';
                hint.style.display = 'inline';
                scheduleCard.style.display = 'block';  // Otomatik modda g√∂ster
            }
        }
        
        function setCheckInterval() {
            const value = document.getElementById('checkIntervalInput').value;
            const seconds = parseInt(value);
            if (seconds < 5 || seconds > 300) {
                alert('L√ºtfen 5-300 saniye arasƒ± bir deƒüer girin');
                return;
            }
            client.publish('thermostat/control/checkinterval', value, {retain: true});
            alert(`Program kontrol periyodu ${seconds} saniye olarak ayarlandƒ±`);
        }

        function selectDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayHours();
        }
        
        function displayHours() {
            const grid = document.getElementById('hourGrid');
            grid.innerHTML = '';
            
            const now = new Date();
            const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = dayMap[now.getDay()];
            const currentHour = now.getHours();
            
            for (let h = 0; h < 24; h++) {
                const hourDiv = document.createElement('div');
                hourDiv.className = 'hour-item';
                
                // ≈ûu anki saat ve bug√ºn ise vurgula
                if (currentDay === today && h === currentHour) {
                    hourDiv.classList.add('current-hour');
                }
                
                // Eƒüer deƒüer yoksa 22 varsayƒ±lan
                const tempValue = schedule[currentDay] && schedule[currentDay][h] !== undefined ? schedule[currentDay][h] : 22;
                
                hourDiv.innerHTML = `
                    <label>${h.toString().padStart(2, '0')}:00</label>
                    <input type="number" 
                           value="${tempValue}" 
                           min="15" 
                           max="30" 
                           step="0.5"
                           onchange="updateHour(${h}, this.value)">
                `;
                grid.appendChild(hourDiv);
            }
        }
        
        function updateHour(hour, temp) {
            const tempValue = parseFloat(temp);
            if (tempValue < 15 || tempValue > 30) {
                showToast('Sƒ±caklƒ±k 15-30¬∞C arasƒ± olmalƒ±!');
                displayHours();
                return;
            }
            schedule[currentDay][hour] = tempValue;
            localStorage.setItem('thermostat_schedule', JSON.stringify(schedule));
            
            if (client && client.connected) {
                const json = JSON.stringify(schedule);
                client.publish('thermostat/schedule/update', json, {retain: true});
                console.log(`${currentDay} ${hour}:00 = ${temp}¬∞C NodeMCU'ya g√∂nderildi`);
                
                // Eƒüer ≈üu anki saat deƒüi≈ütiriliyorsa, hedef sƒ±caklƒ±ƒüƒ± da g√ºncelle
                const now = new Date();
                const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const today = dayMap[now.getDay()];
                const currentHour = now.getHours();
                
                if (currentDay === today && hour === currentHour) {
                    client.publish('thermostat/control/mode', 'auto', {retain: true});
                    client.publish('thermostat/control/target', temp, {retain: true});
                    console.log(`≈ûu anki hedef sƒ±caklƒ±k g√ºncellendi: ${temp}¬∞C (Mod: Otomatik)`);
                    document.getElementById('modeSelect').value = 'auto';
                }
            }
        }
        
        function showCopyModal() {
            // Mevcut g√ºn√º checkbox'lardan kaldƒ±r
            document.querySelectorAll('.day-checkbox input').forEach(cb => {
                cb.checked = false;
                cb.disabled = (cb.value === currentDay);
                if (cb.disabled) {
                    cb.parentElement.style.opacity = '0.5';
                } else {
                    cb.parentElement.style.opacity = '1';
                }
            });
            document.getElementById('copyModal').style.display = 'block';
        }
        
        function closeCopyModal() {
            document.getElementById('copyModal').style.display = 'none';
        }
        
        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function applyCopy() {
            const checkboxes = document.querySelectorAll('.day-checkbox input:checked');
            if (checkboxes.length === 0) {
                showToast('L√ºtfen en az bir g√ºn se√ßin');
                return;
            }
            
            let copiedDays = [];
            checkboxes.forEach(cb => {
                // Array olarak kopyala (object deƒüil)
                schedule[cb.value] = [...schedule[currentDay]];
                copiedDays.push(cb.value);
            });
            
            localStorage.setItem('thermostat_schedule', JSON.stringify(schedule));
            const json = JSON.stringify(schedule);
            client.publish('thermostat/schedule/update', json, {retain: true});
            
            closeCopyModal();
            showToast(`${copiedDays.length} g√ºne kopyalandƒ±!`);
            console.log('Kopyalama NodeMCU\'ya g√∂nderildi:', schedule);
        }
        
        function resetDay() {
            if (confirm('Bu g√ºn√ºn t√ºm saatlerini 22¬∞C yapmak ister misiniz?')) {
                for (let h = 0; h < 24; h++) {
                    schedule[currentDay][h] = 22;
                }
                localStorage.setItem('thermostat_schedule', JSON.stringify(schedule));
                const json = JSON.stringify(schedule);
                client.publish('thermostat/schedule/update', json, {retain: true});
                displayHours();
                showToast('Sƒ±fƒ±rlandƒ± ve NodeMCU\'ya g√∂nderildi!');
            }
        }

        function saveSchedule() {
            localStorage.setItem('thermostat_schedule', JSON.stringify(schedule));
            const json = JSON.stringify(schedule);
            client.publish('thermostat/schedule/update', json, {retain: true});
            showToast('Program NodeMCU\'ya g√∂nderildi!');
            console.log('T√ºm program kaydedildi:', schedule);
        }
        
        function loadSchedule() {
            const saved = localStorage.getItem('thermostat_schedule');
            if (saved) {
                try {
                    schedule = JSON.parse(saved);
                    console.log('Program localStorage\'dan y√ºklendi:', schedule);
                    return true;
                } catch (e) {
                    console.error('Program y√ºkleme hatasƒ±:', e);
                }
            }
            return false;
        }

        // Cihaz durumunu kontrol et (30 saniye mesaj gelmezse offline)
        function checkDeviceStatus() {
            if (deviceOnline && (Date.now() - lastMessageTime > 30000)) {
                deviceOnline = false;
                document.getElementById('deviceStatus').textContent = '‚ö†Ô∏è Cihaz: √áevrimdƒ±≈üƒ±';
                document.getElementById('deviceStatus').className = 'device-status device-offline';
                console.log('‚ö†Ô∏è NodeMCU √ßevrimdƒ±≈üƒ± (30 saniye mesaj yok)');
            }
        }
        
        // Sayfa y√ºklendiƒüinde baƒülan
        window.onload = () => {            // localStorage'dan mod y√ºkle (MQTT gelene kadar ge√ßici)
            const savedMode = localStorage.getItem('thermostat_mode');
            if (savedMode) {
                document.getElementById('modeSelect').value = savedMode;
                updateTargetInputState(savedMode);
            }
            
            // Tu≈ü kilidi durumunu y√ºkle
            const savedKeyLock = localStorage.getItem('thermostat_keylock');
            if (savedKeyLock === 'ON') {
                document.getElementById('keyLockToggle').checked = true;
                document.getElementById('keyLockWarning').classList.add('active');
            }
            
            // Kalibrasyon deƒüerini y√ºkle
            const savedCalibration = localStorage.getItem('thermostat_calibration');
            if (savedCalibration) {
                document.getElementById('calibrationInput').value = parseFloat(savedCalibration);
            }
            
            // LCD kontrast deƒüerini y√ºkle
            const savedContrast = localStorage.getItem('thermostat_contrast');
            if (savedContrast) {
                document.getElementById('contrastInput').value = parseInt(savedContrast);
            }
                        // localStorage'dan y√ºkleme - sadece MQTT gelmezse yedek olarak
            const loaded = loadSchedule();
            if (!loaded) {
                initSchedule();
            }
            
            // Bug√ºn√ºn g√ºn√ºn√º otomatik se√ß
            const now = new Date();
            const dayMap = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const todayKey = dayMap[now.getDay()];
            currentDay = todayKey;
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            const dayButtons = document.querySelectorAll('.day-btn');
            const dayOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const todayIndex = dayOrder.indexOf(todayKey);
            if (todayIndex >= 0 && dayButtons[todayIndex]) {
                dayButtons[todayIndex].classList.add('active');
            }
            
            connectMQTT();
            
            // Cihaz durumunu her 5 saniyede kontrol et
            deviceCheckInterval = setInterval(checkDeviceStatus, 5000);
            
            // 3 saniye sonra MQTT'den veri gelmediyse localStorage'dan g√∂ster
            setTimeout(() => {
                if (!scheduleLoaded) {
                    console.log('MQTT\'den veri gelmedi, localStorage kullanƒ±lƒ±yor');
                    displayHours();
                }
            }, 3000);
        };
    </script>
</body>
</html>
